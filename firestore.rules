rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================
    // 1. HELPER FUNCTIONS
    // =========================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function userProfileExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return isAuthenticated() && userProfileExists() && getUserData().role == 'Admin';
    }
    
    function isManager() {
      return isAuthenticated() && userProfileExists() && (getUserData().role == 'Manager' || getUserData().role == 'Admin');
    }

    // =========================================================
    // 2. COLLECTION RULES
    // =========================================================

    // --- Users ---
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId || isAdmin();
    }

    // --- Financials (Accounts) ---
    match /accounts/{document=**} {
      // SAFE: Staff need to see accounts to pick them in forms
      allow read: if isAuthenticated();
      // SECURE: Only Admin/Manager can change balances or add accounts
      allow create, delete: if isAdmin();
      allow update: if isManager(); 
    }

    // --- Transactions & Bills ---
    // I separated 'ledger' from this list to secure it further down
    match /{collection}/{docId} {
      allow read: if isAuthenticated();
      // Allow staff to create transactions (Sales/Expenses) but NOT edit them later?
      // For safety, I set update to Manager. Adjust if staff need to edit.
      allow create: if isAuthenticated() && 
        collection in ['transactions', 'receivable_transactions', 'payable_bills', 'expense_transactions'];
      allow update: if isManager() && 
        collection in ['transactions', 'receivable_transactions', 'payable_bills', 'expense_transactions'];
      allow delete: if isAdmin();
    }

    // --- THE LEDGER (CRITICAL SECURITY) ---
    // Segregated: Never let standard staff write directly to the ledger
    match /ledger/{document=**} {
      allow read: if isManager(); // Maybe staff don't even need to see the full ledger?
      allow write: if isManager();
    }

    // --- Expense Configuration ---
    match /expenseCategories/{document=**} {
      allow read: if isAuthenticated(); 
      allow write: if isManager();
    }

    match /expenseTemplates/{document=**} {
      allow read: if isAuthenticated(); 
      allow write: if isManager();
    }

    // --- Staff Hub ---
    match /employees/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isManager();
    }
    
    // --- Attendance ---
    match /attendance/{document=**} {
      allow read: if isAuthenticated();
      // Staff can CLOCK IN (create)
      allow create: if isAuthenticated();
      // Only Managers can EDIT/DELETE (Fix mistakes)
      allow update, delete: if isManager();
    }

    // --- CRM (Customers & Vendors) ---
    match /customers/{document=**} {
      allow read: if isAuthenticated(); // Needed for dropdowns
      allow write: if isManager();
    }
    match /vendors/{document=**} {
      allow read: if isAuthenticated(); // Needed for dropdowns
      allow write: if isManager();
    }

    // --- Settings / Config ---
    match /configs/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    match /settings/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- Activity Logs ---
    match /activity_logs/{document=**} {
      allow create: if isAuthenticated(); 
      allow read: if isManager();
      allow delete: if isAdmin();
    }

    // --- Daily Ops ---
    match /daily_ops_sessions/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isManager();
    }
  }
}

